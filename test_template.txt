use std::{env, thread, time};

fn main() {
    let network = env::var("STATSHOUSE_NETWORK").unwrap_or_else(|_| "udp".to_string());
    let mut t = if network == "tcp" {
        statshouse::Transport::tcp("127.0.0.1:13337")
    } else {
        statshouse::Transport::udp("127.0.0.1:13337")
    };
    let mut i = 0;
    while i<{{.NumberOfIterations}} {
    {{- range $v := .Metrics }}
        statshouse::MetricBuilder::new(b"{{ $v.Name }}")
        {{- range $v := $v.Tags -}}
            .tag(b"{{ index $v 0 }}",b"{{ index $v 1 }}")
        {{- end -}}
        {{- if eq $v.Kind 2 -}}
        .write_uniques(&mut t, &[
            {{- range $i, $v := $v.Uniques -}}
                {{ if $i }},{{ end }}{{ $v }}
            {{- end -}}
        ],{{ printf "%.1f" $v.Count }},{{ $v.Timestamp }});
        {{- else if eq $v.Kind 1 -}}
        .write_values(&mut t, &[
            {{- range $i, $v := $v.Values -}}
                {{ if $i }},{{ end }}{{ $v }}
            {{- end -}}
        ],{{ printf "%.1f" $v.Count }},{{ $v.Timestamp }});
        {{- else -}}
        .write_count(&mut t, {{ printf "%.1f" $v.Count }},{{ $v.Timestamp }});
        {{- end -}}
    {{- end }}
    i+=1;
    thread::sleep(time::Duration::from_millis(100));
    }
}
